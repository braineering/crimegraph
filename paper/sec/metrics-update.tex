\section{Metrics Update}
\label{sec:metrics-update}

The advantage of using local metrics to identify hidden and potential links consists in the ability to recompute the metrics on a limited region of the social graph, when a new vertex or edge updates the criminal social network.

The following Algorithm~\ref{alg:metrics-update} is executed by the operator \texttt{GraphUpdate} in Figure~\ref{fig:topology}, when it receives a new tuple $(x,y,w_{x,y})$, representing the interaction between $x$ and $y$ of relevance with weighting factor $w_{x,y}$. 
%
The algorithm generates the set of metrics update required when adding a new interaction to the criminal network.
%
Notice that Algorithm~\ref{alg:metrics-update} covers the updates of all metrics in Equations~\eqref{eqn:salton}-\eqref{eqn:rra-local}.
%
\begin{algorithm}[h!]
  \SetKwProg{Fn}{Function}{}{}
  
  \Fn{receive (x,y,w)} {
  	
	\If{$(x,y)\in E(G)$}{
	  updateLink(x,y,w) \\
	  $U \leftarrow update(x) \cup update(y)$ \\
	  \For{$u\in U$}{
	    emit(TM,u)
	  }
	}

	\ElseIf{$x\in V(G) \land y\in V(G)$}{
	  addLink(x,y,w) \\
	  $U \leftarrow update(x) \cup update(y)$ \\
	  \For{$u\in U$}{
		emit(ALL,u)
	  }
    }

	\ElseIf{$x\in V(G) \land y\notin V(G)$}{
      addLink(x,y,w) \\
	  $U \leftarrow update(y)$ \\
	  \For{$u\in U$}{
	    emit(ALL,u)
	  }
    }

	\ElseIf{$x\notin V(G) \land y\in V(G)$}{
	  addLink(x,y,w) \\
	  $U \leftarrow update(x)$ \\
	  \For{$u\in U$}{
		emit(ALL,u)
	  }
    }  

	\Else{
	  addLink(x,y,w)
    }
  }
  
  \Fn{update (x)}{
    $N \leftarrow Neighbors(x)$ \\
    $U \leftarrow \emptyset$ \\
    \For{$y\in N$}{
      \If{$(x,y)\notin E(G)$}{
        $U \leftarrow U \cup \{(x,y)\}$
      }
	  \For{$z\in N$}{
	  	\If{$(x,z)\notin E(G) \land z\neq y$}{
	  		$U \leftarrow U \cup \{(y,z)\}$
	  	}
	  }
    }    
    \KwResult{$U$}
  }
  \caption{Metrics update when inserting a new interaction}
  \label{alg:metrics-update}
\end{algorithm}

% FUNCTIONS DEFINITION

The function \texttt{emit(TM,u)} lets the operator emit tuples related to metrics based on edge weight (TA, NTA); while \texttt{emit(ALL,u)} do the same for all metrics.
%
The emitted tuples are defined as $(x,y,metric\; name)$ representing a mandatory update of the specified metric for the edge $x,y$.
%
The functions \texttt{addLink(x,y,w)} and \texttt{updateLink(x,y,w)} create and update the edge $(x,y)$ with the given weight $w$, respectively.
%
The function \texttt{Neighbors(x)} returns the set of neighbors of $x$.

% ALGORITHM DESCRIPTION
When a new interaction $(x,y,w_{x,y})$ is injected into the system, the most important aspects to consider are (i) whether or not $x,y\in V$ and (ii) whether or not $(x,y)\in E$.
%
If $(x,y)\in E$, the interaction is not the first one between $x$ and $y$, so the weight $w_{x,y}$ is updated according to EWMA, and only the weight-based metrics should be considered for the update, i.e. BA and RBA.
%
In this case, $x,y\in V$, so the necessary updates are the ones involving the neighbors of both $x$ and $y$.
%
If $(x,y)\notin E$, the interaction is the first one between $x$ and $y$, so the link $(x,y,w_{x,y})$ is created, and all metrics should be considered for the update.
%
In this case, the necessary updates are the ones involving the neighbors of $x$ and/or $y$, depending on whether or not $x\in V$ and/or $y\in V$.
%
Algorithm~\ref{alg:metrics-update} allows to minimize the firing of updates, only considering the strictly necessary ones according to the locality of interactions.
