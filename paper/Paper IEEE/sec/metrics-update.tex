\section{Metrics update}
\label{sec:metrics-update}

When considering local metrics, a new interaction should fire only local updates, avoiding combinatorial explosion of updates.
The following algorithm generates the set of metrics update required when adding a new interaction.
Notice that Algorithm~\ref{alg:metrics-update} covers the updates of all metrics in Equations~\ref{eqn:ta-local}-\ref{eqn:resource-allocation}. 
Algorithm~\ref{alg:metrics-update} is executed by the operator \texttt{GraphUpdate} in Figure~\ref{fig:topology}, once every time it receives a new tuple $(x,y,w)$, representing the interaction between $x$ and $y$ of relevance $w$.

\begin{algorithm}[h!]
  \SetKwProg{Fn}{Function}{}{}  
  
  \vspace{1em}
  
  \Fn{receive (x,y,w)} {
  	
	\If{$(x,y)\in E(G)$}{
	  updateLink(x,y,w) \\
	  $U \leftarrow update(x) \cup update(y)$ \\
	  \For{$u\in U$}{
	    emit(TM,u)\;
	  }
	}

	\ElseIf{$x\in V(G) \land y\in V(G)$}{
	  addLink(x,y,w) \\
	  $U \leftarrow update(x) \cup update(y)$ \\
	  \For{$u\in U$}{
		emit(ALL,u)\;
	  }
    }

	\ElseIf{$x\in V(G) \land y\notin V(G)$}{
      addLink(x,y,w) \\
	  $U \leftarrow update(y)$ \\
	  \For{$u\in U$}{
	    emit(ALL,u)\;
	  }
    }

	\ElseIf{$x\notin V(G) \land y\in V(G)$}{
	  addLink(x,y,w) \\
	  $U \leftarrow update(x)$ \\
	  \For{$u\in U$}{
		emit(ALL,u)\;
	  }
    }  

	\Else{
	  addLink(x,y,w)
    }
  }
  
  \vspace{1em}
  
  \Fn{update (x)}{
    $N \leftarrow Neighbours(x)$ \\
    $U \leftarrow \emptyset$ \\
    \For{$y\in N$}{
      \If{$(x,y)\notin E(G)$}{
        $U \leftarrow U \cup \{(x,y)\}$
      }
	  \For{$z\in N$}{
	  	\If{$(x,z)\notin E(G) \land z\neq y$}{
	  		$U \leftarrow U \cup \{(y,z)\}$
	  	}
	  }
    }    
    \KwResult{$U$}
  }
  \vspace{1em}
  \caption{Metrics update when inserting a new interaction}
  \label{alg:metrics-update}
\end{algorithm}

Some functions in Algorithm~\ref{alg:metrics-update} have not been formally defined because they are pretty self-explanatory. For reader's sake, we briefly describe them here. \texttt{emit(TM,u)} lets the operator emit tuples and \texttt{emit(ALL,u)} let the operator emit traffica related and all tuples in the form \texttt{(x,y,HIDDEN)} and \texttt{(x,y,POTENTIAL)}, meaning that an hidden or potential score update is necessary for the edge $(x,y)$, respectively.
\texttt{updateLink(x,y,w)} updates the existent edge $(x,y)$ with the new EWMA weight value. 
\texttt{addLink(x,y,w)} inserts the edge $(x,y)$ with weight $w$. 
\texttt{Neighbours(x)} return the set of neighbours of $x$.
